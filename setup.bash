#!/usr/bin/env bash

# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'

echo "Alloverse app setup wizard"
echo "--------------------------"

if [ -d "allo" ]; then
    echo "Project already initialized; use \`./allo/assist upgrade\` to fetch latest version."
    exit
fi

PROJNAME=`basename $(pwd)`

read -p "Create new project '$PROJNAME'? (y/N) " answer
if [ "$answer" != "y" ] ; then
    echo "Exiting..."
    exit
fi

if [ ! -d ".git" ]; then
    echo "git init'ing"
    git init
fi

echo
echo "EXTRACTING template app..."

base64 -d <<EOF | tar xz
H4sIAIT8/l4AA+08a3PTyLL7Wb9iVsCJzZHlR0IC2c1ShpjF54SESgJ7t0KOkeWxLSJLWj3y2C3Ob7/dPTPSSH4E2AB163qgYmump1/T04+R5ONed/9Vz56Nfvh6rdVqbW9tMfzc2X5En62OuKa23e6w9ub2zs6jnc2d7U3Wane2t7d/YK2vyFPesiR1YmAl4Jc3wQo4ABuPV4wLUVj++X+k3WNd3w8veZxw5kQRS/ks8p2UG8bp1EsY/HeCMojNfg8z5kK3cRZzZ8ScYZilZZjz2jRNo2S32XRUt+2Gs+aIX3I/jBoAkjTrRqih3kjYFR8mXsptwxgMoiRJLXYDlJJpmPkjlmSzmRN7fwL+YMT4NXDpBQgQsygOP3A3ZVMe8x8HA8O4d4/tC0peMDGMbhT5nuukHtBLYILLQaqYM5j/3s+c5nugeBoyNISUpVOhCKTihkGAiD3oDpUigLDL2TiMQVdJCgQsFmeBYbx//96wSd6mkyRekmI3c9QM0AWZmE1XiV1SDE7+PutP/H5lGrjvHz1avv9xv1T2/+bmzg/s0Vfmi9r/8/2v2etXo3GL/+882q6u/yZ8W/v/b9Hu/djMkrg59IImDy7Z0EmmRsJT1uBZyCIv4mPH843+i5O9+xvvgnfphmG87B339t6PvDhwZpzdb703Dt50/9U/3TPv4xA4eXDu4Fc/eGkD8YqvpmGMwsGU+xGr1dlfBoPG3WnIzDeJM+G7TDrNn8EpDn8xtfG30JHs6j34bcxTd1rtxLYfXgV+CHEJPTl6WHT74ZgBWzwY8cD1wP17wQgjAh9hEPBD92Ls+TyposuiSeyM+CIqL7xJFgMiDH1XU0fEDQycIIJGFLZXhXBiKbRz5LARGsWPRVEIugI2CjFoCakRMXTO7CoCDDg/Z7H/yyLMx1mQiHiJe74S4hIZ4/TZ115qfKRVkwzPLRx1QwQkjAFPbVuydI+p+D/x0mk2pOCfRzzxzUvCuJEFXnrTHPrhsDlzkpTHzW4C5pc0n4cj3uyNvDSELgB/i+DPMs8f2W5CNFxglTXGyckBMxU1yC9s509YmAUEgb/mwIm8pDlENOJv8hR6GnLB9h7ZLZP9woQZi3H7QxIGRO++sHI5KqzVBtsWHcyFXCjlDVw7qTWxVhWdvcDORSqbXcCOYo1I4ve9YTNMrre3tOsrLyhd+16QAcSncCd4uV8Dm1cgkj4yXJcco/3k/JYxDsNQw9e0bXa/jbO8MTtj5v17Jmv4KWuz85/IXgmD3O+FNY09w3AdSBHvt2HfGdoWY3VD2Wlhb3oXCUAdP/1k5Pu/PG0OBuUpIMqsdkqsalhyllUj1tUFiKDBIoH7HZ3kwzJLOTIY5onjGt/b31cbxX+0cVzcr0RjdfzvbG6BVZfj/xaMr+P/t2iNhtFoMGUAhrh8HkY3sTeZpqzm1lmn1X7C4mtPDr7m8cxLKMBBdYg11/CGwX4NIJpabBxzjvHJnTrxhFuibrphEXhYjIjDFKo2cn8QeaIbgESUKZaaSThOr7Asw7AEDix0PQrQo9DNZjxIRf1GcZHVMEyaJ3KGWSc6I+746FYIIWdqlF1BCMIwDeE6jT0X0VgA5/oZxS417HszTxLB6SR/AngRX5aAKMiwxWbhyBvjJyf5omzoe8nUYiMPsQ+zFDoT7HR5gLNAmibUigmHTAAwQA6ACEUEz3mUgT5EPQEXUl1IHZKLcFaWB3Q1zuIAqHKaMyIWk5DoUiEMnThjHMLmvkIZIcpDKAXRkl25iqdY5g4hPJJYYrGDMAWuZc4BVKJipeVQMsWEZsil+kT6BF2IUQjHUNZsCLslSD1YjyiMiW5VYlvx8bLHTo5enP7WhSjVP2Gvj4/e9vd7+8zsnsC1abHf+qcvj96cMoA47h6e/s6OXrDu4e/s3/3DfYv1/uf1ce/khB0dI7b+q9cH/R509w+fH7zZ7x/+yp7B1MOjU3bQf9U/BbynR0RTYuv3ThDfq97x85dw2X3WP+if/m4hrhf900PE/OLomHXZ6+7xaf/5m4PuMXv95vj10UkPmNgHzIf9wxfHQKj3qnd4agNh6GO9t3DBTl52Dw6QGqLrvgExjpFR9vzo9e/H/V9fnrKXRwf7Peh81gP+us8OeoIaSPf8oNt/ZbH97qvurz2adQSISEiEFGyy3172sBepduH/89P+0SHK8/zo8PQYLi0Q9/g0n/1b/6Rnse5x/wQ18+L46BVJitqFSUeEB6Ye9gQi1Hx5gQAEr9+c9HKcbL/XPQB0JzhZyqrgaZENyDDAENDFsD32Fxuo9HiPmS27bXdMBnlE424bctELXEgi7xyzlIcL7OoqcZ2ID9DrDWZOhIJC2Id04907k52jqO+gmZbsNItOM+8c5p3DvG+c943zviDvC/K+OO+L874070uh7+MSVgcelH24LsRsU85p4qLgGdeFxS5xk0eOFye1ytw6+h62COPZJaK5MKDwMRThcRaQ89XhIb4Agpin4NCqeM7cc/Im4FaDiQ3MzJy0BjxmD1pb1+AY3N3hTcpr9foSKrRAg8Dza5eOr5Exg8z3zZWTUmfoc5xm4akgJsiMCUis+UBbH6GDRuBCfAKn0AvdGD+92M18JwboMcTHwOVPDco/CfQM8J6Lqo7HcRjXTHcO3qwz4o/pU/ZYGmfcEKhi52rCU8Fju87+u8dAUuQi4NfUXWd7oi9PctHdYpUC0ZU5cezcYI875cD9Bb8RZ6Iw0RtRCIAwBDEAHD9LIgeKKEIhlIB7tyWycDSRwj6ILNmETLjTm4jXLog9UPtsyMFQS0m31ACYDBEmxe+ymXcNsQVwq37gj3AlpkqvUT3iG3ITsH+ytqH3A/EAyd4DBDrJxQSFiEIrkoRCVHgSJbAn94S3SGhCaHsQ++O0FmMNL2yqdqlsqYy+tL6wXKJwkZZ6ZjKotARKiOFQvQmUpgUGAiPmuYnmwH25PKUVxnQL04FioUp7eeVaiU1392u1VDsXSjsk1i7J/TcU99dtivuIVTeiWuUGhBYq7mPD3EAM0Lk7gUyntnH24M937ca7zTY48/MNS3djRAsmrPZQtC8UFXQftCVxxQ6dQ4s1vGAsdmQwFnsfTRpWCT8ACD9+3mMNcI9Te5pNuOr8ZY8VfflKylXMwE9EYB2wdoIBnJJx4JY0F2qyk8I2aDWF8qUmKp75gd3emoBfJkF0gdEYBih1OTTCmonDKVzAwlvL8EVrZ5ZHqU+OKwvVx0WfBFDupoSe+iTAMAx97shoqgSmQGkIcOhWa7UwFqQ4DzeNXDq5vLI3l/gspThWSCgWcVwsidTnuEJFKHt+vRC7Wqd8bYTCc9uiik5toJL91pjWzdTEu86SwIz3+dfMv0RMqm4pcQo3SCAy2ra9MGyTB4eLtoVFGWi0Zt4Dq0Vw5Q4B+kwNenIoD7+VTQCwQoWCEAQSV+z9BBDt6QyZ4H0oLbMoYbMolavLeSMO9ednzLPQ91vox4RTm0/ukioazD8xs7PQI8G3IV6O8Q+hI8xEJMvR+V7KY8dPhPMuo0NlEAYYpy+UVtWN8tTylqc5LNel3IgCA/XS13wD+74EJrfwcd6DYq4j8kjYvVDUj65xUVMLBibAaF1bbhq7B2BqkTEd4+kZ9OyiG4d19urnlEfRXD30yaX2tPhTsgFCiwnIQjc/on0wEPu44HOWTAr79L0AVi3MAvQp7bzbDf1Sr2a7gIM1WFtJo0MW31VSRKmnJiemhlRIaEKWWNAuFA42x01ZF0K+uaAAiUhK6NgDvNvgw4dJwlsaEavAXbik6tYGJUahF6SDNBxk6fhxLZDxEk//d5vNxI29KE3sxPPtMJ403Vmi+pqRM+F2NI2e4gMGA2+0F0AN+g/49K4SfBoBKHrXTsmHU+gc+2EYGzKbhCDbut6Z99tSZLJD4gnzMX3G6injWsCabHurjqp+0gHjZQ/gEq86j+fRjcefhG+r9WQbMXY6WxbDrgfUVVDqPL6NUrv1ibQ62532FmHtbLUUNdGpcYIUSwfrWvtkBleYmso/s8Cj6J0bDNt4cL0BRhcstS0KJgM5cSCcaC0ptmfQphRBZmosoZ20abHtusVYe5tpkJ0FkE+gROsAqITEE5IMRCA3g8m4rA5hblXX80ZfA14asDijx61WnT2Eb1utFiioBrOp38X+f9LyQVOruhpp0FbKXaEemREKD1ZIPHWSiuaUHy+BJEriVUBLhnwnSaX3+4CuHO2h7MwF3DVV47E4F/hQN5Tvu2Y/s82O7uzmffIHiGBQKaQxuCg0bQdSLaxppJVpRaHCilyhI30iMOOy0nGPPCUhLKoCIiYAtt3eKYAzgFXGKuck/I8M6//iJpJUDleyoT19EArAj0el+1tYrQPo7tgLRuB7r8U/KHkqN7oWi1/dQJKnqg7KFR3RLWj+52y0f372+InTHT47nye8xBJkYiVxK3MtpszZV3lCzkxpqgyhQm+5x7qeU5ieM+GZ02fpSltrmZK7IiW/VW0le9fkKWCEgVFtayjplCFtbuV2hAVpDWbhEbugqAjKlFSzHE9ZDqQOmm0uXJaSHgiJKHjxCE5fZduGDhtvZFsLHen8KYCkWFnVVfS+BP3taBHlgsPLeYwq8ok91y6Wo7xS13NJ0YLcD4wnr+RcP0zw/swfWZiKZwpzk1nhiGVwqTpi9BDVhNjSC4sCtGQSFrtW5lAc7+UhjGbJnRJo9/YXCqZ2hTxREBsiWXZ+EADlVXLKEuLvCHoVxqMlskqZVIlzhqDnnyqgnCUlJCpLhNTqIEHiFqHpCHJOZK1+LdYIc3BPxUP4fjX1fF6UBFJZIlwtVJlWrFrkgoTl44nnLEpvIBWTboWYerq8lDgvVRI6T9iGUDVeaFuDKBzjo8NpeCFnQUGE00gHmvSiFg/O881VPuwFPIcglYbnswSVEWIal01EUi6L4Y0FYCGtkEs/cEYAPD21JMAtu3/jfAMPhjasDXncP3+0ADNWGYs44F1lLbfaxwW/oSO7uzATwc4KO/n4hXYCTC5GCtrG8LcysyvpXPhXcRzOq0f9pIvFZqg42djdEJ4Gt/Xn62yRAHja/ekCIAPOGHPTef4XsSIC/vIlJKno6Jd66ARyqQpOeJpvSiCP21KZzvfZih/vait+/OytSBnD3Kk2WuO5Ul/5QLplaiOlk+j20pHO0pHNpSNbS0ceLR3ZXjqys3Tk8dKRJ0tHGktHUn1EBk11Prh8KFg+dKYPUQCTA3/pA8JlicNFcQ9QO/RXh3WFZ60YKJ7jlcbx4KhkGGcw49xYeuCvU1iaMSIV/fy/KE9lxQFMrboNIFAiMpn30E0LvFx8r0/eccjpOfGEnsCiZ3jw3oM0azaB/EnchlAICznySCSOKksOpeIVFvonYnW0KNWjQ95FXgQkwxk/74mjgVWpHKk0jR3Px2gwceKhM+HzyVt+uG/IDnoa+Hs/s3eXTXv/46s9AXrL+x/b23Pvf2xtbrfWz39+i6aOl2J0fLDRz9rn4AfdCzovd9IpbVztEu9n/7Rh2zjDtjeaT9Fq9A56+wOtKvPoIfXIxxdABNxG+VmwmP+ReUDYxGtT3SzGe7zXxagZ+bboMzW/Jm5EHYTuRU3PH8Qz+wnNdkb4rGhN8GXqj/Ob81PwWFH3lRKRDihe7uiPtJvFEuzDmUkJlHkO2jszvZF5LiZGAJTWzAPxWkhXPHEvKLL+Pj5eQ95TYRaTrmIIYyXW9Uf1TUsDJ9f0d2+n5jqlx+drKT63m74Vz+iVcjPHnRJf0iwUd7jIikOCMfVJWRxD5HibP/IHepvV8sUp4azr1PAl1ERmVaKdmVKBjQN876Fxvb1lnu/BwF8MZ+/ND8sXPYBBxV8SmnhQkKR7pvYCRQWCfbQWEP3NC0bhVaLIVolqw5LsPh9mk1wzI98vkaZ3OXTCCLCQ8CvHLWSdl1YOz8s6uoGLEk16n2Qe5CMR/agy55yF6trB4um2QY+k5MCAsia2qU17IanRCtatIpvCjnqe+sCiD/g1hJ0kt3PTxpdjgS3gmLJwYRClAzy5pQ4h8xhXXqVhML/EIeD8CQbR2m5YFtGz0rB3bO1AVnBTKqIkheqLOnPYBRIsJJ049caQkB06M076dounrIQWiues5IsrJ4AZ7L+E0FqAiJyu/EpqKbFauIrSRrJYhVHyE+V9/ikMCFwx9/fpRWd6Nl7fo6OiW/oDSkOb5NTK0xbPehH6I04J9U2S8lnNVC8Vgq5HVZrVdQEYnV1Y7HuLl0jGFT6LXoCCCH9BcegkXJEkJ6RNiWnkFYLPMS3tVcdKM6uRxQcLxxfV9v7OS2pN+TSbvvtI00oByVNdFXsErvcQ9D+qr7ppvH6g1w0KtWgv170zQU5dFhAd+uqV2ZUASgh1GMXOG1IGDp+ZkF7T6/gQOM2RfG0Txs1zfd1mEdqRFnDCLLX/9CLB/jKGNXLEL/uFNrBAVi9NzQLAxhrhBw0C5iiLwK+NUcUkhRGU8cwuEUgZjcQwZ8YKOp6VGCpvUQnkzkbq6EVav5pt2zAGJOqldZiCS/bRXL3QjsKIBwWGvBzLfNIlQe6ia6yZDx2JRfbiXQleU8ev5K5l2MbZVV7zYF7dPmPBCPEhXIkZm/kx2Hju8WSNnGmW/Fxx02JcZXm8iNukwmLhJwUfeJ8XItstzF7lJGh+rTSroFtxrlpcm1PIXolCSRv/3VO6KGIqQAsi42rAKu4X4k0oVh1Vd8+1W/o5g7SSSUldNXVH7D8Pkoc1u1GHj/v4RNeDtlmvCkiBHqJ6Ef4uyo9Dp6Voh7LVLun0l7iaf+Vyjmd95dWnLvZdZL1/N2n2xlQsdc7pFFJ791c7RinVKPLerTZJvMBegAsbuaR4iGCbwguKrPwSnQ0Kftf1H9X/6uXeu0Yu2y31f3tre2fu/c/2o3X9/y2arLbi8MPLcKadAYh+kbkIo1UPuMbuvoc2quZQDZg5Zv4ga5TMA5CZ4ZCZPx46XAKFJQltMPnUxszBDaAOIVzpnKFO0x4uKY1qRxauDOA/QcAUFEXFKsq+p1jtqZ25kpoolL6YoCi8nsp669Mo4rO0X0pPFJdPqaYU7nLFkQ7hlyjE4iKKB4k4sjH1Ybm2aqkyr4FHO/nxzqfAQhnqRjP/syboR0imQa/2JVhresmUTfwQytnEkKdFNbMobyG6Pvc9To+r5sMCNcRVHACIzFswmnn4HDO+VEs/CeVEUYF/5niBWf/e2/bOGir2a9P4gt9/au+017//9C0arj+a9FcM/7f+/t9Oe7P6+0/bnfY6/n+LJo9plZ8UDrNGfllkApaoLszB4PXx0b8Ou696g4FpqBdE8GeE9lg3imoCRf76B9rUW49fwSg41JMshmKc1+DrszALRkmtZbGWvQN/LEDexotH+KddV5iHWZrSqQLOoe/6bJvmt2gOoWjZHUv9KZBMYmf4UhXFMP3X/FpDxhqSOP3ZrGLrADYlza4zGp1kw0v4WhMMLh4r6IJCBKAdBl2ooC7pNy20e8ylw62XHALQj+o2Lv7YoqZH9RX7d+XvNsF0vIozQPRF629PvNSbBGHM79iwtHbb/m/tzO3/rdb6/t83aZRyP3zYfIjJoqFdYaqqXQ8ztGatIwm/N+vrtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rtm7rBu1/Ad68mUoAeAAA
EOF

sed -i "s#__PROJNAME__#${PROJNAME}#g" lua/main.lua

echo
echo "FETCHING git dependencies..."

mkdir -p allo/deps
git submodule add https://github.com/alloverse/alloui-lua allo/deps/alloui
git submodule update --init --recursive allo/deps/alloui
git submodule add https://github.com/luapower/luajit.git allo/deps/luajit-bin

echo
echo "DOWNLOADING libraries using assist..."

./allo/assist upgrade
