#!/usr/bin/env bash

# http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'

echo "Alloverse app setup wizard"
echo "--------------------------"

if [ -d "allo" ]; then
    echo "Project already initialized; use \`./allo/assist upgrade\` to fetch latest version."
    exit
fi

PROJNAME=`basename $(pwd)`

read -p "Create new project '$PROJNAME'? (y/N) " answer
if [ "$answer" != "y" ] ; then
    echo "Exiting..."
    exit
fi

if [ ! -d ".git" ]; then
    echo "git init'ing"
    git init
fi

echo
echo "EXTRACTING template app..."

base64 -d <<EOF | tar xz
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
EOF

sed -i "s#__PROJNAME__#${PROJNAME}#g" lua/main.lua

echo
echo "FETCHING git dependencies..."

mkdir -p allo/deps
git submodule add https://github.com/alloverse/alloui-lua allo/deps/alloui
git submodule update --init --recursive allo/deps/alloui
git submodule add https://github.com/luapower/luajit.git allo/deps/luajit-bin

echo
echo "DOWNLOADING libraries using assist..."

./allo/assist upgrade